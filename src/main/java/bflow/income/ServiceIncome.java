package bflow.income;

import bflow.auth.entities.User;
import bflow.auth.repository.RepositoryUser;
import bflow.expenses.entity.Expense;
import bflow.income.DTO.IncomeRequest;
import bflow.income.DTO.IncomeResponse;
import bflow.income.entity.Income;
import bflow.wallet.RepositoryWallet;
import bflow.wallet.RepositoryWalletUser;
import bflow.wallet.entities.Wallet;
import bflow.wallet.entities.WalletUser;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.UUID;

/**
 * Service for managing income operations within wallets.
 */
@Service
@RequiredArgsConstructor
@Transactional
public class ServiceIncome {

    /**
     * Repository for income entity operations.
     */
    private final RepositoryIncome repositoryIncome;

    /**
     * Repository for wallet user entity operations.
     */
    private final RepositoryWalletUser repositoryWalletUser;

    private final RepositoryWallet repositoryWallet;

    /**
     * Repository for user entity operations.
     */
    private final RepositoryUser repositoryUser;

    /**
     * Creates a new income entry for the specified wallet and user.
     *
     * @param request the income request containing income details
     * @param userId the unique identifier of the authenticated user
     * @return the created income as an IncomeResponse
     * @throws AccessDeniedException if the user does not have access to
     *         the wallet
     */
    public IncomeResponse newIncome(
            final IncomeRequest request,
            final UUID userId
    ) {

        // Validate wallet access (supports shared wallets)
        WalletUser walletUser = repositoryWalletUser
                .findByWalletIdAndUserId(request.getWalletId(),
                        userId)
                .orElseThrow(() ->
                        new AccessDeniedException(
                                "You do not have access to this wallet"
                        )
                );

        Wallet wallet = walletUser.getWallet();

        // Get contributor
        User contributor = repositoryUser.findById(userId)
                .orElseThrow(() ->
                        new AccessDeniedException(
                                "Authenticated user not found"
                        )
                );

        // Map dto to entity
        Income income = mapToEntity(request, wallet, contributor);

        // Add income to wallet
        wallet.setBalance(
                wallet.getBalance().add(income.getAmount())
        );

        // Save income into database
        Income savedIncome = repositoryIncome.save(income);

        return mapToResponse(savedIncome);
    }

    public IncomeResponse updateIncome(
            final UUID incomeId,
            final IncomeRequest request,
            final UUID userId
    ) {
        Income income = repositoryIncome.findById(incomeId)
                .orElseThrow(() ->
                        new IllegalArgumentException("Income not found")
                );

        Wallet oldWallet = income.getWallet();

        // Validate access
        repositoryWalletUser
                .findByWalletIdAndUserId(
                        oldWallet.getId(),
                        userId
                )
                .orElseThrow(() ->
                        new AccessDeniedException(
                                "You do not have access to this wallet"
                        )
                );

        Wallet newWallet = repositoryWallet.findById(request.getWalletId())
                .orElseThrow(() ->
                        new IllegalArgumentException("Target wallet not found")
                );

        repositoryWalletUser
                .findByWalletIdAndUserId(
                        newWallet.getId(),
                        userId
                )
                .orElseThrow(() ->
                        new AccessDeniedException(
                                "You do not have access to the target wallet"
                        )
                );

        BigDecimal oldAmount = income.getAmount();
        BigDecimal newAmount = request.getAmount();

        if (oldWallet.getId().equals(newWallet.getId())) {

            // Same wallet → apply difference
            BigDecimal difference = newAmount.subtract(oldAmount);
            oldWallet.setBalance(
                    oldWallet.getBalance().add(difference)
            );

        } else {

            // Different wallet → full transfer logic

            // Remove old impact
            oldWallet.setBalance(
                    oldWallet.getBalance().subtract(oldAmount)
            );

            // Apply new impact
            newWallet.setBalance(
                    newWallet.getBalance().add(newAmount)
            );

            // Reassign wallet
            income.setWallet(newWallet);
        }

        income.setTitle(request.getTitle());
        income.setDescription(request.getDescription());
        income.setAmount(newAmount);
        income.setDate(request.getDate());
        income.setType(request.getType());
        income.setTaxable(Boolean.TRUE.equals(request.getTaxable()));
        income.setRecurring(Boolean.TRUE.equals(request.getRecurring()));
        income.setRecurrencePattern(request.getRecurrencePattern());


        return mapToResponse(income);
    }

    public void deleteIncome(
            final UUID incomeId,
            final UUID userId
    ) {

        Income income = repositoryIncome.findById(incomeId)
                .orElseThrow(() ->
                        new IllegalArgumentException("Income not found")
                );

        // Validate access
        repositoryWalletUser
                .findByWalletIdAndUserId(
                        income.getWallet().getId(),
                        userId
                )
                .orElseThrow(() ->
                        new AccessDeniedException(
                                "You do not have access to this wallet"
                        )
                );

        Wallet wallet = income.getWallet();

        // Subtract income value from wallet balance
        wallet.setBalance(
                wallet.getBalance().subtract(income.getAmount())
        );

        repositoryIncome.delete(income);
    }

    /**
     * Maps an IncomeRequest DTO to an Income entity.
     *
     * @param request the income request containing income details
     * @param wallet the wallet to associate with the income
     * @param contributor the user contributing the income
     * @return the mapped Income entity
     */
    private Income mapToEntity(
            final IncomeRequest request,
            final Wallet wallet,
            final User contributor
    ) {

        Income income = new Income();

        income.setTitle(request.getTitle().trim());
        income.setDescription(request.getDescription());

        income.setAmount(
                request.getAmount().setScale(2, RoundingMode.HALF_EVEN)
        );

        income.setDate(request.getDate());
        income.setWallet(wallet);
        income.setContributor(contributor);
        income.setType(request.getType());

        income.setTaxable(Boolean.TRUE.equals(request.getTaxable()));
        income.setRecurring(Boolean.TRUE.equals(request.getRecurring()));
        income.setRecurrencePattern(request.getRecurrencePattern());

        return income;
    }

    /**
     * Maps an Income entity to an IncomeResponse DTO.
     *
     * @param income the income entity to map
     * @return the mapped IncomeResponse
     */
    private IncomeResponse mapToResponse(final Income income) {

        IncomeResponse response = new IncomeResponse();

        response.setId(income.getId().toString());
        response.setTitle(income.getTitle());
        response.setDescription(income.getDescription());
        response.setAmount(income.getAmount());
        response.setDate(income.getDate());

        response.setIncomeType(income.getType().name());

        response.setWalletId(income.getWallet().getId().toString());
        response.setWalletName(income.getWallet().getName());

        response.setContributorId(income.getContributor().getId()
                .toString());

        response.setContributorName(
                income.getContributor().getEmail()
        );

        response.setCreatedAt(income.getCreatedAt());

        return response;
    }
}
